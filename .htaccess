#################################
## No access
#################################
<Files .htaccess >
	Deny from all
</Files>

<Files *.inc.php>
	Deny from all
</Files>

<Files *.class.php>
	Deny from all
</Files>

<Files *.orig>
	Deny from all
</Files>

<Files *.bak>
	Deny from all
</Files>


<FilesMatch ".(htaccess|htpasswd|ini|phps|fla|psd|log|sh)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

#################################
## General
#################################

#SetEnv TZ Europe/Amsterdam # server location for timezone

<IfModule mod_deflate.c>
	# compress text, html, javascript, css, xml:
	AddOutputFilterByType DEFLATE text/plain
	AddOutputFilterByType DEFLATE text/html
	AddOutputFilterByType DEFLATE text/xml
	AddOutputFilterByType DEFLATE text/css
	AddOutputFilterByType DEFLATE application/xml
	AddOutputFilterByType DEFLATE application/xhtml+xml
	AddOutputFilterByType DEFLATE application/rss+xml
	AddOutputFilterByType DEFLATE application/javascript
	AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# disable directory browsing
Options All -Indexes

#################################
## Pretty Urls
#################################
Options +FollowSymlinks
RewriteBase /
RewriteEngine On

# proc/self/environ? no way!
RewriteCond %{QUERY_STRING} proc/self/environ [OR]
# Block out any script trying to set a mosConfig value through the URL
RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|\%3D) [OR]
# Block out any script trying to base64_encode crap to send via URL
RewriteCond %{QUERY_STRING} base64_encode.*(.*) [OR]
# Block out any script that includes a <script> tag in URL
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
# Block out any script trying to set a PHP GLOBALS variable via URL
RewriteCond %{QUERY_STRING} GLOBALS(=|[|\%[0-9A-Z]{0,2}) [OR]
# Block out any script trying to modify a _REQUEST variable via URL
RewriteCond %{QUERY_STRING} _REQUEST(=|[|\%[0-9A-Z]{0,2})
# Send all blocked request to homepage with 403 Forbidden error!
RewriteRule ^(.*)$ / [F,L]

# redirect for API
RewriteCond %{HTTP_HOST} ^api.beta\. [NC]
RewriteRule ^ http://beta.monipal.com/api%{REQUEST_URI} [L,P]

RewriteCond %{HTTP_HOST} ^api\. [NC]
RewriteRule ^ http://www.monipal.com/final/api%{REQUEST_URI} [L,P]

# Remove multiple slashes anywhere in URL
RewriteCond %{REQUEST_URI} ^(.*)//(.*)$
RewriteRule . %1/%2 [R=302,L]

# Add trailing slash if not an existing page
# Forces a trailing slash to be added
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !(\.[a-zA-Z0-9]{1,5}|/)$
RewriteRule (.*)$ /$1/ [R=302,L]

# Add www before domain
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{HTTP_HOST} !^localhost:8080$ [NC]
RewriteCond %{HTTP_HOST} !^192.168.1.102:8080$ [NC]
RewriteCond %{HTTP_HOST} !^beta\. [NC]
RewriteCond %{HTTP_HOST} !^test\. [NC]
RewriteCond %{HTTP_HOST} !^api\. [NC]
RewriteRule ^ http://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=302]

# RewriteRule ^en/$ index.php?lang=en [L]
RewriteRule ^nl/$ index.php?lang=nl [L]

RewriteRule ^dinner/([0-9]+)/([0-9]+)/([0-9\-]+)/([0-9\-]+)/$ 	/dinner.php?gid=$1&uid=$2&date=$3&role=$4	[L]		#http://beta.monipal.com/dinner.php?gid=10&uid=19&date=2013-11-01&role=1
RewriteRule ^dinner/([0-9]+)/([A-Za-z]+)/$						/dinner.php?gid=$1&tb=$2 					[L]		#'dinner/' . $group->id . '&tb=stats
RewriteRule ^dinner-history/([0-9]+)/([0-9]+)/$				    /dinner-history.php?gid=$1&p=$2 			[L]		#'dinner/' . $group->id . '&tb=stats
RewriteRule ^tasks/([0-9]+)/([0-9]+)/([0-9\-]+)/([0-9]+)/$ 		/tasks.php?gid=$1&tid=$2&date=$3&uid=$4		[L]		#http://beta.monipal.com/tasks.php?gid=10&tid=26&date=2013-11-04&uid=19
RewriteRule ^tasks/([0-9]+)/([A-Za-z]+)/$						/tasks.php?gid=$1&task=$2 					[L]		#'&task=added'
RewriteRule ^task-ical/([0-9]+)/$								/task-ical.php?gid=$1 						[L]		#
RewriteRule ^edit-task/([0-9]+)/([a-zA-Z]+)/$				 	/tasks.php?gid=$1&action=$2					[L] 	#http://beta.monipal.com/tasks.php?gid=10&action=emailreminder
RewriteRule ^cost/([0-9]+)/([0-9]+)/([0-9\-]+)/$ 				/cost.php?gid=$1&uid=$2&date=$3				[L]		#http://beta.monipal.com/cost.php?gid=10&uid=13&date=29-10-2013
RewriteRule ^cost/([0-9]+)/([A-Za-z]+)/$						/cost.php?gid=$1&cost=$2 					[L]		#http://beta.monipal.com/cost.php?gid=10&cost=added
RewriteRule ^cost/([0-9]+)/([0-9]+)/$ 							/cost.php?gid=$1&uid=$2 					[L]		#http://beta.monipal.com/cost.php?gid=10&uid=10
RewriteRule ^edit-cost/([0-9]+)/([0-9]+)/$						/edit-cost.php?gid=$1&cid=$2 				[L]		#edit-cost.php?gid='.$group->id.'&cid='.$idcost
RewriteRule ^edit-task/([0-9]+)/([0-9]+)/$				 		/edit-task.php?gid=$1&tid=$2				[L] 	#http://beta.monipal.com/edittask.php?gid=10&tid=14
RewriteRule ^delete-task/([0-9]+)/$								/delete-task.php?tid=$1 					[L]		#?tid=
RewriteRule ^delete-account/([A-Za-z]+)/$						/delete-account.php?da=$1 					[L]		#deleteaccount.php?da=yes
RewriteRule ^delete-group/([0-9]+)/([A-Za-z]+)/$				/delete-group.php?gid=$1&dg=$2 				[L]		#delete-group.php?gid='.$group->id.'&dg=yes
RewriteRule ^([A-Za-z]+)/demo-cost-management/([0-9]+)/$		/demo-cost-management.php?uid=$2&lang=$1	[L]		#demo-cost.php?uid='.$uid
RewriteRule ^([A-Za-z]+)/demo-cost-management/([A-Za-z]+)/$		/demo-cost-management.php?cost=$2&lang=$1	[L]		#democost.php?cost=demo
RewriteRule ^([A-Za-z]+)/demo-cost-management/([0-9]+)/([0-9\-]+)/$ 				/demo-cost-management.php?uid=$2&date=$3&lang=$1				[L]		#http://beta.monipal.com/
RewriteRule ^([A-Za-z]+)/demo-task-list/$						/demo-task-list.php?lang=$1					[QSA,L]		#en/demo-task-list/?tid=10&date=2013-11-11&uid=19
RewriteRule ^([A-Za-z]+)/demo-task-list/([A-Za-z]+)/$			/demo-task-list.php?task=$2&lang=$1			[L]		#demo-task?task=demo
RewriteRule ^([A-Za-z]+)/demo-dinner-list/([0-9]+)/([0-9]+)/([0-9\-]+)/([0-9\-]+)/$ 	/demo-dinner-list.php?gid=$2&uid=$3&date=$4&role=$5&lang=$1	[L]
RewriteRule ^([A-Za-z]+)/demo-dinner-list/([A-Za-z]+)/$			/demo-dinner-list.php?tb=$2 				[L]		#demo-dinner.php?tb=left
RewriteRule ^activation/(.*)/$									/activation.php?ac=$1 						[L]		#http://beta.monipal.com/activation.php?ac=99ce6a0c2283b7efc4689cbaf696ac84358eb09e
RewriteRule ^accept-invite/(.*)/([0-9]+)/$						/accept-invite.php?e=$1&gid=$2				[L]		#http://beta.monipal.com/accept-invite.php?e=pascalworek@gmail.com&gid=30
RewriteRule ^([A-Za-z]+)/register/([0-9]+)/(.*)/$				/register.php?e=$3&gid=$2&lang=$1			[L]
RewriteRule ^logbook/([0-9]+)/([A-Za-z]+)/([0-9]+)/$            /logbook.php?gid=$1&cat=$2&range=$3       	[L]
RewriteRule ^([0-9a-zA-Z_\-]+)/([0-9]+)/$						/$1.php?gid=$2 								[L]
RewriteRule ^edit-sticky-note/([0-9]+)/([0-9]+)/$ 			    /edit-sticky-note.php?gid=$1&sid=$2 		[L]     #edit-sticky-note.php?gid=65&sid=7
RewriteRule ^reset-password/(.*)/$								/reset-password.php?ac=$1					[L]


# RewriteRule ^en/(.*)/$ 									/$1.php?lang=en [QSA,L]
RewriteRule ^nl/(.*)/$ 									/$1.php?lang=nl [QSA,L]

# Map http://www.example.com to /final.
RewriteCond %{HTTP_HOST} !^localhost:8080$ [NC]
RewriteRule ^$ /final/ [L]

# Map http://www.example.com/x to /final/x unless there is a x in the web root.
RewriteCond %{HTTP_HOST} !^localhost:8080$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/final/
RewriteRule ^(.*)$ /final/$1 [L]

# Add .php for single pages 
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.*)/$ /$1.php [L,QSA]



#################################
## Errors
#################################

ErrorDocument 404 /error-page.php